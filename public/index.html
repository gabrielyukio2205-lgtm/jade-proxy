<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>J.A.D.E. - Portf√≥lio Interativo</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap');
    :root { --bg:#0d1117; --surface:#161b22; --primary:#58a6ff; --text:#c9d1d9; --border:#30363d; }
    body{font-family:'Fira Code',monospace;background:var(--bg);color:var(--text);margin:0;display:flex;justify-content:center;align-items:center;height:100vh}
    #chat-container{width:90%;max-width:720px;height:80vh;background:var(--surface);border:1px solid var(--border);border-radius:8px;display:flex;flex-direction:column;box-shadow:0 8px 24px rgba(0,0,0,.45)}
    #chat-header{padding:1rem;border-bottom:1px solid var(--border);font-weight:700;text-align:center}
    #chatbox{flex:1;padding:1rem;overflow-y:auto}
    .message{margin-bottom:1rem;display:flex;flex-direction:column}
    .sender{font-size:.78rem;color:#8b949e;margin-bottom:.25rem}
    .sender.user{color:var(--primary);align-self:flex-end}
    .text{background:var(--bg);padding:.75rem;border-radius:6px;max-width:80%;word-wrap:break-word}
    .user .text{background:#212c42;align-self:flex-end}
    #input-area{display:flex;padding:1rem;border-top:1px solid var(--border);align-items:center}
    #userInput{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:.75rem;color:var(--text);font-family:inherit}
    button{margin-left:10px;background:var(--primary);color:#042033;border:none;border-radius:6px;padding:0 .9rem;cursor:pointer;font-weight:700;height:40px;font-size:1.1rem;line-height:40px}
    #sendBtn{padding:0 1.2rem}
  </style>
</head>
<body>
  <div id="chat-container">
    <div id="chat-header">J.A.D.E. <span>//</span> Ativa</div>
    <div id="chatbox">
      <div class="message bot"><div class="sender">J.A.D.E.</div><div class="text">Sistema online. Aguardando seu comando. Envie uma imagem ou digite uma mensagem.</div></div>
    </div>
    <div id="input-area">
      <!-- NOVOS ELEMENTOS: Bot√£o para imagem e o input de arquivo escondido -->
      <input type="file" id="imageInput" accept="image/*" style="display: none;">
      <button id="imageBtn" title="Enviar Imagem">üñºÔ∏è</button>

      <input id="userInput" placeholder="Digite sua mensagem..." autocomplete="off"/>
      <button id="sendBtn">Enviar</button>
    </div>
  </div>

<script>
const API_URL = 'https://jade-proxy.onrender.com/chat';
const chatbox = document.getElementById('chatbox');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');

// NOVOS ELEMENTOS: Capturando os bot√µes e inputs de arquivo
const imageInput = document.getElementById('imageInput');
const imageBtn = document.getElementById('imageBtn');

// Adicionando evento para que o bot√£o de imagem acione o clique no input escondido
imageBtn.addEventListener('click', () => imageInput.click());
imageInput.addEventListener('change', () => {
    if (imageInput.files.length > 0) {
        appendMessage('Sistema', `Imagem "${imageInput.files[0].name}" selecionada. Envie uma mensagem para process√°-la.`);
    }
});


function appendMessage(sender, text){
  const senderClass = sender === 'Voc√™' ? 'user' : 'bot';
  const el = document.createElement('div');
  el.className = `message ${senderClass}`;
  el.innerHTML = `<div class="sender ${senderClass}">${sender}</div><div class="text">${escapeHtml(text)}</div>`;
  chatbox.appendChild(el);
  chatbox.scrollTop = chatbox.scrollHeight;
}

function escapeHtml(s){ 
  return s.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[ch])); 
}

// NOVA FUN√á√ÉO: Converte um arquivo para uma string Base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

async function sendMessage(){
  const message = userInput.value.trim();
  let image_base64 = null;
  
  if (!message && imageInput.files.length === 0) return; // N√£o faz nada se tudo estiver vazio

  // MODIFICA√á√ÉO: L√≥gica para pegar a imagem e convert√™-la
  if (imageInput.files.length > 0) {
      appendMessage('Voc√™', `${message} [Imagem Anexada]`);
      image_base64 = await fileToBase64(imageInput.files[0]);
      imageInput.value = ''; // Limpa o input ap√≥s o envio
  } else {
      appendMessage('Voc√™', message);
  }

  userInput.value = '';

  try {
    // Adiciona um estado de "pensando" para a J.A.D.E.
    appendMessage('J.A.D.E.', 'Processando...');
    const jadeThinkingMessage = chatbox.lastElementChild;

    const resp = await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      // MODIFICA√á√ÉO: O corpo agora pode conter a imagem em Base64
      body: JSON.stringify({ 
          user_input: message, 
          image_base64: image_base64 
      })
    });

    if (!resp.ok) throw new Error('HTTP '+resp.status);
    const json = await resp.json();
    
    let botResponse = "[Resposta em formato inesperado]";
    if (json.success && json.bot_response) {
      botResponse = json.bot_response;
    } else if (json.error) {
      botResponse = `[Erro na API J.A.D.E.: ${json.error}]`;
    }
    
    // Atualiza a mensagem "Processando..." com a resposta final
    jadeThinkingMessage.querySelector('.text').innerHTML = escapeHtml(botResponse);

  } catch (err) {
    console.error(err);
    appendMessage('Erro do Sistema', 'Falha ao conectar com J.A.D.E.');
  }
}

// Modificado para chamar a fun√ß√£o sem argumentos
sendBtn.addEventListener('click', sendMessage);
userInput.addEventListener('keydown', e=>{ 
  if(e.key==='Enter' && !e.shiftKey){ 
    e.preventDefault(); 
    sendMessage(); 
  }
});
</script>
</body>
</html>
